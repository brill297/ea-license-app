<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EA Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    .card { background: white; padding: 20px; border-radius: 10px; max-width: 500px; margin: auto; box-shadow: 0 0 10px #ddd; }
    input, select, button { width: 100%; padding: 10px; margin: 10px 0; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <h2>EA Settings Dashboard</h2>
    <input type="text" id="licenseKey" placeholder="Enter License Key">
    <button onclick="validateLicense()">Load Settings</button>

    <div id="settingsForm" class="hidden">
      <label>Lot Size:</label>
      <input type="number" id="lotSize" step="0.01">

      <label>Stop Loss:</label>
      <input type="number" id="stopLoss">

      <label>Take Profit:</label>
      <input type="number" id="takeProfit">

      <label>Auto Risk:</label>
      <select id="autoRisk">
        <option value="false">Off</option>
        <option value="true">On</option>
      </select>

      <label>EA Status:</label>
      <select id="isActive">
        <option value="true">Running</option>
        <option value="false">Paused</option>
      </select>

      <button onclick="saveSettings()">Save Changes</button>
    </div>

    <p id="statusMsg"></p>
  </div>

  <script>
    const supabaseUrl = "https://gqtfbteiocwzievktwej.supabase.co";
    const supabaseApiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdGZidGVpb2N3emlldmt0d2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NjA1NTMsImV4cCI6MjA2NzAzNjU1M30.FnvC_rBqdflL1zjNuYXK5-FIXLGKXs8eAFm7WwtKQ_c";

    async function validateLicense() {
      const key = document.getElementById("licenseKey").value.trim();
      if (!key) return alert("Enter a license key");

      const { data, error } = await fetch(`${supabaseUrl}/rest/v1/ea_settings?license_key=eq.${key}`, {
        headers: {
          "apikey": supabaseApiKey,
          "Authorization": `Bearer ${supabaseApiKey}`,
          "Content-Type": "application/json"
        }
      }).then(res => res.json().then(json => ({ data: json, error: null })))
        .catch(err => ({ data: null, error: err }));

      if (error || !data || data.length === 0) {
        document.getElementById("statusMsg").innerText = "License not found or invalid.";
        return;
      }

      const settings = data[0];
      document.getElementById("lotSize").value = settings.lot_size;
      document.getElementById("stopLoss").value = settings.stop_loss;
      document.getElementById("takeProfit").value = settings.take_profit;
      document.getElementById("autoRisk").value = settings.auto_risk;
      document.getElementById("isActive").value = settings.is_active;
      document.getElementById("settingsForm").classList.remove("hidden");
      document.getElementById("statusMsg").innerText = "Settings loaded.";
    }

    async function saveSettings() {
      const key = document.getElementById("licenseKey").value.trim();
      const updates = {
        lot_size: parseFloat(document.getElementById("lotSize").value),
        stop_loss: parseFloat(document.getElementById("stopLoss").value),
        take_profit: parseFloat(document.getElementById("takeProfit").value),
        auto_risk: document.getElementById("autoRisk").value === "true",
        is_active: document.getElementById("isActive").value === "true",
        updated_at: new Date().toISOString()
      };

      const { error } = await fetch(`${supabaseUrl}/rest/v1/ea_settings?license_key=eq.${key}`, {
        method: "PATCH",
        headers: {
          "apikey": supabaseApiKey,
          "Authorization": `Bearer ${supabaseApiKey}`,
          "Content-Type": "application/json",
          "Prefer": "return=minimal"
        },
        body: JSON.stringify(updates)
      });

      if (error) {
        document.getElementById("statusMsg").innerText = "Failed to save settings.";
      } else {
        document.getElementById("statusMsg").innerText = "Settings saved successfully!";
      }
    }
  </script>
</body>
</html>