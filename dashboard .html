<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EA Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; padding: 20px; }
    .card { background: white; padding: 20px; max-width: 600px; margin: 0 auto; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    input, select, button { width: 100%; padding: 10px; margin: 10px 0; }
    .status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Expert Advisor Dashboard</h2>

    <div id="status" class="status">Validating License...</div>

    <div id="dashboard" style="display: none;">
      <label>Lot Size</label>
      <input type="number" id="lot_size" min="0.01" step="0.01" value="0.10"/>

      <label>Stop Loss</label>
      <input type="number" id="stop_loss" value="50"/>

      <label>Take Profit</label>
      <input type="number" id="take_profit" value="100"/>

      <label>Auto Risk</label>
      <select id="auto_risk">
        <option value="on">On</option>
        <option value="off">Off</option>
      </select>

      <button onclick="saveSettings()">Save Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    // Supabase config
    const supabaseUrl = "https://gqtfbteiocwzievktwej.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdGZidGVpb2N3emlldmt0d2VqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NjA1NTMsImV4cCI6MjA2NzAzNjU1M30.FnvC_rBqdflL1zjNuYXK5-FIXLGKXs8eAFm7WwtKQ_c";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const licenseKey = localStorage.getItem('license_key');

    async function validateLicense() {
      if (!licenseKey) {
        document.getElementById("status").textContent = "No license key found. Redirecting...";
        setTimeout(() => window.location.href = "index.html", 2000);
        return;
      }

      const { data, error } = await supabase
        .from("licenses")
        .select("*")
        .eq("license_key", licenseKey)
        .eq("is_valid", true)
        .single();

      if (error || !data) {
        document.getElementById("status").textContent = "Invalid license key. Redirecting...";
        setTimeout(() => window.location.href = "index.html", 2000);
      } else {
        document.getElementById("status").textContent = "License Valid âœ”";
        document.getElementById("dashboard").style.display = "block";
        loadSettings();
      }
    }

    async function saveSettings() {
      const settings = {
        lot_size: parseFloat(document.getElementById("lot_size").value),
        stop_loss: parseFloat(document.getElementById("stop_loss").value),
        take_profit: parseFloat(document.getElementById("take_profit").value),
        auto_risk: document.getElementById("auto_risk").value,
        license_key: licenseKey,
      };

      const { error } = await supabase
        .from("ea_settings")
        .upsert(settings, { onConflict: ['license_key'] });

      alert(error ? "Failed to save settings!" : "Settings saved successfully!");
    }

    async function loadSettings() {
      const { data } = await supabase
        .from("ea_settings")
        .select("*")
        .eq("license_key", licenseKey)
        .single();

      if (data) {
        document.getElementById("lot_size").value = data.lot_size || 0.10;
        document.getElementById("stop_loss").value = data.stop_loss || 50;
        document.getElementById("take_profit").value = data.take_profit || 100;
        document.getElementById("auto_risk").value = data.auto_risk || "off";
      }
    }

    function logout() {
      localStorage.removeItem("license_key");
      window.location.href = "index.html";
    }

    validateLicense();
  </script>
</body>
</html>
